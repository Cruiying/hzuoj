<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hqz.hzuoj.mapper.discussion.DiscussionMapper">
    <resultMap id="discussionResultMap" type="com.hqz.hzuoj.bean.discussion.Discussion">
        <id column="discussion_id" property="discussionId"/>
        <result column="discussion_content" property="discussionContent"/>
        <result column="discussion_create_time" property="discussionCreateTime"/>
        <result column="discussion_modify_time" property="discussionModifyTime"/>
        <result column="discussion_title" property="discussionTitle"/>
        <result column="discussion_top" property="discussionTop"/>
        <result column="discussion_reply_count" property="discussionReplyCount"/>
        <result column="discussion_commend_count" property="discussionCommendCount"/>
        <result column="discussion_browse_count" property="discussionBrowseCount"/>
        <association property="user" javaType="com.hqz.hzuoj.bean.user.User">
            <id column="user_id" property="userId"/>
            <result column="username" property="username"/>
            <result column="email" property="email"/>
            <result column="register_time" property="registerTime"/>
            <result column="gender" property="gender"/>
            <result column="user_img" property="UserImg"/>
            <result column="user_rating" property="userRating"/>
            <result column="user_submit_total" property="userSubmitTotal"/>
            <result column="user_challenge_total" property="userChallengeTotal"/>
        </association>
    </resultMap>
<!--    回复map-->
    <resultMap id="discussionCommentResultMap" type="com.hqz.hzuoj.bean.discussion.DiscussionComment">
        <id column="comment_id" property="commentId"/>
        <result column="comment_content" property="commentContent"/>
        <result column="comment_time" property="commentTime"/>
        <association property="user" javaType="com.hqz.hzuoj.bean.user.User">
            <id column="user_id" property="userId"/>
            <result column="username" property="username"/>
            <result column="user_img" property="UserImg"/>
            <result column="user_rating" property="userRating"/>
        </association>
        <association property="discussion" javaType="com.hqz.hzuoj.bean.discussion.Discussion">
            <id column="discussion_id" property="discussionId"/>
        </association>
        <association property="parentComment" javaType="com.hqz.hzuoj.bean.discussion.DiscussionComment">
            <id column="parent_comment_id" property="commentId"/>
        </association>
    </resultMap>
<!--    保存讨论-->
    <insert id="saveDiscussion">
        <selectKey order="AFTER" keyProperty="discussionId" resultType="int">
            select LAST_INSERT_ID()
        </selectKey>
        INSERT INTO hzuoj_discussions (
        discussion_content,discussion_create_time,discussion_modify_time,
        discussion_title,user_id,discussion_top,discussion_reply_count,
        discussion_commend_count,discussion_browse_count)
        VALUES(#{discussionContent}, #{discussionCreateTime}, #{discussionModifyTime},
        #{discussionTitle},#{user.userId}, #{discussionTop}, #{discussionReplyCount},
        #{discussionCommendCount}, #{discussionBrowseCount})
    </insert>
<!--    删除回复-->
    <delete id="commentDelete">
        delete from hzuoj_discussions_comments where comment_id = #{commentId} and user_id = #{user.userId}
    </delete>
<!--    删除回复-->
    <delete id="deleteComment">
        delete from hzuoj_discussions_comments where comment_id = #{commentId}
    </delete>
    <!--    获取讨论-->
    <select id="getDiscussion" resultMap="discussionResultMap">
        SELECT * FROM hzuoj_discussions d
        INNER JOIN hzuoj_users u
        ON d.user_id = u.user_id
        WHERE d.discussion_id = #{discussionId}
    </select>
<!--    获取讨论列表-->
    <select id="getDiscussions" resultMap="discussionResultMap">
        SELECT
          d.discussion_id, d.discussion_title,
          d.discussion_browse_count,d.discussion_commend_count,d.discussion_reply_count,
          d.discussion_create_time,d.discussion_modify_time, d.discussion_top,
          u.*
        FROM
          hzuoj_discussions d
          INNER JOIN hzuoj_users u
            ON d.user_id = u.user_id
            <where>
                1 = 1
                <if test="discussionId != null">
                    and d.discussion_id = #{discussionId}
                </if>
                <if test="userId != null">
                    and u.user_id = #{userId}
                </if>
                <if test="discussionTitle != null">
                    and d.discussion_title like '%${discussionTitle}%'
                </if>
            </where>

        ORDER BY d.discussion_top DESC
            <if test="order != null and order == 1">
                , d.discussion_create_time desc
            </if>
            <if test="order != null and order == 2">
                , d.discussion_reply_count desc
            </if>
            <if test="order != null and order == 3">
                , d.discussion_browse_count desc
            </if>
        ,d.discussion_id DESC
    </select>
<!--    更新讨论-->
    <update id="updateDiscussion">
        update hzuoj_discussions set
        discussion_content=#{discussionContent},discussion_modify_time=#{discussionModifyTime},
        discussion_title=#{discussionTitle}
        where discussion_id = #{discussionId}
    </update>
<!--    保存回复-->
    <insert id="saveDiscussionComment">
        <selectKey order="AFTER" keyProperty="commentId" resultType="int">
            select LAST_INSERT_ID()
        </selectKey>
        INSERT INTO hzuoj_discussions_comments (
        comment_content,comment_time,user_id,
        discussion_id, parent_comment_id)
        VALUES(#{commentContent}, #{commentTime}, #{user.userId},
        #{discussion.discussionId}, #{parentComment.commentId})
    </insert>
<!--    获取回复列表-->
    <select id="getDiscussionComments" resultMap="discussionCommentResultMap">
        select * from hzuoj_discussions_comments dc
        inner join hzuoj_users u on dc.user_id = u.user_id
        where dc.discussion_id = #{discussionId}
    </select>
<!--    获取回复-->
    <select id="getDiscussionComment" resultMap="discussionCommentResultMap">
        select * from hzuoj_discussions_comments dc
        inner join hzuoj_users u on dc.user_id = u.user_id
        where dc.comment_id = #{commentId}
    </select>
<!--    更新讨论数量-->
    <update id="updateDiscussionCount">
        update hzuoj_discussions set
        discussion_reply_count = discussion_reply_count + #{replyCount},
        discussion_commend_count = discussion_commend_count + #{commendCount},
        discussion_browse_count = discussion_browse_count + #{browseCount}
        where discussion_id = #{discussionId}
    </update>
</mapper>